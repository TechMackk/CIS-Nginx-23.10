################################################################################
# File: roles/rhel_hardening/templates/audit.rules.j2
# Purpose: Comprehensive auditd rules based on CIS Benchmark
# Author: DevOps Automation Team
# Last Updated: October 22, 2025
# Reference: CIS RHEL 8/9 Benchmark Section 4.1.3
################################################################################

## First rule - delete all existing rules
-D

## Buffer Size
## Increase buffer to handle busy systems (CIS 4.1.1.4)
-b 8192

## Failure Mode
## 0=silent 1=printk 2=panic
-f 1

################################################################################
## CIS 4.1.3.1 - Ensure changes to system administration scope (sudoers) is collected
################################################################################
-w /etc/sudoers -p wa -k scope
-w /etc/sudoers.d/ -p wa -k scope

################################################################################
## CIS 4.1.3.2 - Ensure actions as another user are always logged
################################################################################
-a always,exit -F arch=b64 -C euid!=uid -F auid!=unset -S execve -k user_emulation
-a always,exit -F arch=b32 -C euid!=uid -F auid!=unset -S execve -k user_emulation

################################################################################
## CIS 4.1.3.3 - Ensure events that modify date and time information are collected
################################################################################
-a always,exit -F arch=b64 -S adjtimex,settimeofday -k time-change
-a always,exit -F arch=b32 -S adjtimex,settimeofday,stime -k time-change
-a always,exit -F arch=b64 -S clock_settime -k time-change
-a always,exit -F arch=b32 -S clock_settime -k time-change
-w /etc/localtime -p wa -k time-change

################################################################################
## CIS 4.1.3.4 - Ensure events that modify the system's network environment are collected
################################################################################
-a always,exit -F arch=b64 -S sethostname,setdomainname -k system-locale
-a always,exit -F arch=b32 -S sethostname,setdomainname -k system-locale
-w /etc/issue -p wa -k system-locale
-w /etc/issue.net -p wa -k system-locale
-w /etc/hosts -p wa -k system-locale
-w /etc/sysconfig/network -p wa -k system-locale
-w /etc/sysconfig/network-scripts/ -p wa -k system-locale
-w /etc/NetworkManager/ -p wa -k system-locale

################################################################################
## CIS 4.1.3.5 - Ensure events that modify the system's Mandatory Access Controls are collected
################################################################################
-w /etc/selinux/ -p wa -k MAC-policy
-w /usr/share/selinux/ -p wa -k MAC-policy

################################################################################
## CIS 4.1.3.6 - Ensure login and logout events are collected
################################################################################
-w /var/log/lastlog -p wa -k logins
-w /var/run/faillock/ -p wa -k logins

################################################################################
## CIS 4.1.3.7 - Ensure session initiation information is collected
################################################################################
-w /var/run/utmp -p wa -k session
-w /var/log/wtmp -p wa -k logins
-w /var/log/btmp -p wa -k logins

################################################################################
## CIS 4.1.3.8 - Ensure discretionary access control permission modification events are collected
################################################################################
-a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -k perm_mod
-a always,exit -F arch=b32 -S chmod,fchmod,fchmodat -F auid>=1000 -F auid!=unset -k perm_mod
-a always,exit -F arch=b64 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=unset -k perm_mod
-a always,exit -F arch=b32 -S chown,fchown,fchownat,lchown -F auid>=1000 -F auid!=unset -k perm_mod
-a always,exit -F arch=b64 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=unset -k perm_mod
-a always,exit -F arch=b32 -S setxattr,lsetxattr,fsetxattr,removexattr,lremovexattr,fremovexattr -F auid>=1000 -F auid!=unset -k perm_mod

################################################################################
## CIS 4.1.3.9 - Ensure unsuccessful unauthorized file access attempts are collected
################################################################################
-a always,exit -F arch=b64 -S open,openat,openat2,open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -k access
-a always,exit -F arch=b32 -S open,openat,openat2,open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=unset -k access
-a always,exit -F arch=b64 -S open,openat,openat2,open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=unset -k access
-a always,exit -F arch=b32 -S open,openat,openat2,open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=unset -k access

################################################################################
## CIS 4.1.3.10 - Ensure successful file system mounts are collected
################################################################################
-a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=unset -k mounts
-a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=unset -k mounts

################################################################################
## CIS 4.1.3.11 - Ensure use of privileged commands is collected
################################################################################
## This will be generated dynamically based on system
## Find all SUID/SGID programs: find / -xdev \( -perm -4000 -o -perm -2000 \) -type f
## For each one, add: -a always,exit -F path=/path/to/binary -F perm=x -F auid>=1000 -F auid!=unset -k privileged

################################################################################
## CIS 4.1.3.12 - Ensure file deletion events by users are collected
################################################################################
-a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=unset -k delete
-a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat,rmdir -F auid>=1000 -F auid!=unset -k delete

################################################################################
## CIS 4.1.3.13 - Ensure changes to system administration scope (sudoers) is collected
################################################################################
-w /etc/sudoers -p wa -k scope
-w /etc/sudoers.d/ -p wa -k scope

################################################################################
## CIS 4.1.3.14 - Ensure system administrator command executions (sudo) are collected
################################################################################
-a always,exit -F arch=b64 -C euid!=uid -F euid=0 -F auid>=1000 -F auid!=unset -S execve -k actions
-a always,exit -F arch=b32 -C euid!=uid -F euid=0 -F auid>=1000 -F auid!=unset -S execve -k actions

################################################################################
## CIS 4.1.3.15 - Ensure kernel module loading and unloading is collected
################################################################################
-a always,exit -F arch=b64 -S init_module,finit_module,delete_module,create_module,query_module -F auid>=1000 -F auid!=unset -k modules
-a always,exit -F arch=b32 -S init_module,finit_module,delete_module,create_module,query_module -F auid>=1000 -F auid!=unset -k modules
-w /usr/sbin/insmod -p x -k modules
-w /usr/sbin/rmmod -p x -k modules
-w /usr/sbin/modprobe -p x -k modules

################################################################################
## Additional Security-Critical File Monitoring
################################################################################

## Monitor critical system files
-w /etc/passwd -p wa -k identity
-w /etc/group -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity

## Monitor SSH configuration
-w /etc/ssh/sshd_config -p wa -k sshd
-w /etc/ssh/sshd_config.d/ -p wa -k sshd

## Monitor PAM configuration
-w /etc/pam.d/ -p wa -k pam
-w /etc/security/limits.conf -p wa -k pam
-w /etc/security/limits.d/ -p wa -k pam
-w /etc/security/namespace.conf -p wa -k pam
-w /etc/security/namespace.d/ -p wa -k pam

## Monitor cron and scheduled tasks
-w /etc/cron.allow -p wa -k cron
-w /etc/cron.deny -p wa -k cron
-w /etc/cron.d/ -p wa -k cron
-w /etc/cron.daily/ -p wa -k cron
-w /etc/cron.hourly/ -p wa -k cron
-w /etc/cron.monthly/ -p wa -k cron
-w /etc/cron.weekly/ -p wa -k cron
-w /etc/crontab -p wa -k cron
-w /var/spool/cron/ -p wa -k cron

## Monitor systemd services
-w /etc/systemd/ -p wa -k systemd
-w /usr/lib/systemd/ -p wa -k systemd

## Monitor firewall configuration
-w /etc/firewalld/ -p wa -k firewall
-w /etc/sysconfig/iptables -p wa -k firewall
-w /etc/sysconfig/ip6tables -p wa -k firewall

## Monitor AppArmor (if installed)
-w /etc/apparmor/ -p wa -k apparmor
-w /etc/apparmor.d/ -p wa -k apparmor

################################################################################
## Make the configuration immutable
################################################################################
## This must be the last rule
-e 2

################################################################################
# END OF FILE: roles/rhel_hardening/templates/audit.rules.j2
################################################################################